name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
          
      - name: Install dependencies
        run: pnpm install
        
      - name: Checkout content from dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          path: content-source
          
      - name: Copy content files
        run: |
          # Copy content from dev branch to main branch workspace
          if [ -d "content-source/content/projects" ]; then
            echo "Copying content from dev branch..."
            cp -r content-source/content/projects content/
            echo "Content copied successfully"
            ls -la content/projects/ | head -10
          else
            echo "No content/projects found in dev branch, creating sample content..."
            mkdir -p content/projects/sample-project
            cat > content/projects/sample-project/index.md << EOF
          ---
          title: Sample Project
          description: This is a sample project for demonstration
          type: Design
          location: Sample City
          date: 2024-01-01
          featured: true
          ---
          
          This is a sample project created for the GitHub Pages deployment.
          EOF
            # Create a simple 1x1 pixel image as thumbnail
            echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" | base64 -d > content/projects/sample-project/thumbnail.jpg
          fi
          
      - name: Build
        run: pnpm run build
        env:
          NODE_ENV: production
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './build'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4